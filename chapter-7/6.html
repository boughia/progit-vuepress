<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>重写历史 | Pro Git</title>
    <meta name="description" content="Pro Git 第二版中文版">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.130772cc.css" as="style"><link rel="preload" href="/assets/js/app.e343c26e.js" as="script"><link rel="preload" href="/assets/js/2.c0327591.js" as="script"><link rel="preload" href="/assets/js/111.a049971f.js" as="script"><link rel="prefetch" href="/assets/js/10.0f9cab2e.js"><link rel="prefetch" href="/assets/js/100.83085317.js"><link rel="prefetch" href="/assets/js/101.56c6cce3.js"><link rel="prefetch" href="/assets/js/102.415183d7.js"><link rel="prefetch" href="/assets/js/103.65e1f37c.js"><link rel="prefetch" href="/assets/js/104.4844f2f3.js"><link rel="prefetch" href="/assets/js/105.66c87d19.js"><link rel="prefetch" href="/assets/js/106.05b2e48e.js"><link rel="prefetch" href="/assets/js/107.929c5d0f.js"><link rel="prefetch" href="/assets/js/108.7b376e69.js"><link rel="prefetch" href="/assets/js/109.1a730133.js"><link rel="prefetch" href="/assets/js/11.a6d7b909.js"><link rel="prefetch" href="/assets/js/110.191355ad.js"><link rel="prefetch" href="/assets/js/112.482ffc61.js"><link rel="prefetch" href="/assets/js/113.d94b639c.js"><link rel="prefetch" href="/assets/js/114.8b9356fb.js"><link rel="prefetch" href="/assets/js/115.ebf1e18a.js"><link rel="prefetch" href="/assets/js/116.18b899b1.js"><link rel="prefetch" href="/assets/js/117.42a1b8c4.js"><link rel="prefetch" href="/assets/js/118.3a9d2ee3.js"><link rel="prefetch" href="/assets/js/119.4020833f.js"><link rel="prefetch" href="/assets/js/12.5d2796d3.js"><link rel="prefetch" href="/assets/js/120.9fae7990.js"><link rel="prefetch" href="/assets/js/121.cb3ef973.js"><link rel="prefetch" href="/assets/js/13.f69c9e48.js"><link rel="prefetch" href="/assets/js/14.6debe4be.js"><link rel="prefetch" href="/assets/js/15.a7c94022.js"><link rel="prefetch" href="/assets/js/16.6609021c.js"><link rel="prefetch" href="/assets/js/17.34ba32b5.js"><link rel="prefetch" href="/assets/js/18.4dd74348.js"><link rel="prefetch" href="/assets/js/19.2f410429.js"><link rel="prefetch" href="/assets/js/20.16ec0bd3.js"><link rel="prefetch" href="/assets/js/21.ad1ca29b.js"><link rel="prefetch" href="/assets/js/22.293aa5c6.js"><link rel="prefetch" href="/assets/js/23.025d3c7a.js"><link rel="prefetch" href="/assets/js/24.770fb3e1.js"><link rel="prefetch" href="/assets/js/25.6ce5a0ac.js"><link rel="prefetch" href="/assets/js/26.6404265b.js"><link rel="prefetch" href="/assets/js/27.62decef4.js"><link rel="prefetch" href="/assets/js/28.d1136794.js"><link rel="prefetch" href="/assets/js/29.95a71153.js"><link rel="prefetch" href="/assets/js/3.c6496835.js"><link rel="prefetch" href="/assets/js/30.eae133de.js"><link rel="prefetch" href="/assets/js/31.a6e572c3.js"><link rel="prefetch" href="/assets/js/32.4fc54ce1.js"><link rel="prefetch" href="/assets/js/33.d1c0ecba.js"><link rel="prefetch" href="/assets/js/34.29586ee8.js"><link rel="prefetch" href="/assets/js/35.8e480916.js"><link rel="prefetch" href="/assets/js/36.5b537183.js"><link rel="prefetch" href="/assets/js/37.40c06fd9.js"><link rel="prefetch" href="/assets/js/38.555815d4.js"><link rel="prefetch" href="/assets/js/39.6d5293e5.js"><link rel="prefetch" href="/assets/js/4.e8424aa9.js"><link rel="prefetch" href="/assets/js/40.78797741.js"><link rel="prefetch" href="/assets/js/41.ac76af08.js"><link rel="prefetch" href="/assets/js/42.e7d51b5d.js"><link rel="prefetch" href="/assets/js/43.b20d0fd6.js"><link rel="prefetch" href="/assets/js/44.e29a7c46.js"><link rel="prefetch" href="/assets/js/45.cdea70ee.js"><link rel="prefetch" href="/assets/js/46.9c95c270.js"><link rel="prefetch" href="/assets/js/47.ba588e60.js"><link rel="prefetch" href="/assets/js/48.a8b188ed.js"><link rel="prefetch" href="/assets/js/49.5c609647.js"><link rel="prefetch" href="/assets/js/5.b1d6f09c.js"><link rel="prefetch" href="/assets/js/50.662cc18e.js"><link rel="prefetch" href="/assets/js/51.5ff994dd.js"><link rel="prefetch" href="/assets/js/52.b1b6dd6c.js"><link rel="prefetch" href="/assets/js/53.bd783506.js"><link rel="prefetch" href="/assets/js/54.a05ff5b6.js"><link rel="prefetch" href="/assets/js/55.c30a6cad.js"><link rel="prefetch" href="/assets/js/56.44021f37.js"><link rel="prefetch" href="/assets/js/57.90e56f36.js"><link rel="prefetch" href="/assets/js/58.9ec15505.js"><link rel="prefetch" href="/assets/js/59.8f4ffc72.js"><link rel="prefetch" href="/assets/js/6.49fca771.js"><link rel="prefetch" href="/assets/js/60.8064b38b.js"><link rel="prefetch" href="/assets/js/61.d570ac20.js"><link rel="prefetch" href="/assets/js/62.c66ac933.js"><link rel="prefetch" href="/assets/js/63.d01f285e.js"><link rel="prefetch" href="/assets/js/64.a04e3c07.js"><link rel="prefetch" href="/assets/js/65.af0f13b3.js"><link rel="prefetch" href="/assets/js/66.f81074cc.js"><link rel="prefetch" href="/assets/js/67.47db8798.js"><link rel="prefetch" href="/assets/js/68.50332586.js"><link rel="prefetch" href="/assets/js/69.059056ac.js"><link rel="prefetch" href="/assets/js/7.225eae41.js"><link rel="prefetch" href="/assets/js/70.c46fd0e9.js"><link rel="prefetch" href="/assets/js/71.d45f53f9.js"><link rel="prefetch" href="/assets/js/72.eef7975a.js"><link rel="prefetch" href="/assets/js/73.d947c914.js"><link rel="prefetch" href="/assets/js/74.cc528edb.js"><link rel="prefetch" href="/assets/js/75.7e89a25f.js"><link rel="prefetch" href="/assets/js/76.68b7cb39.js"><link rel="prefetch" href="/assets/js/77.f51671b0.js"><link rel="prefetch" href="/assets/js/78.d940a766.js"><link rel="prefetch" href="/assets/js/79.657d22ce.js"><link rel="prefetch" href="/assets/js/8.1c488769.js"><link rel="prefetch" href="/assets/js/80.b7eef56c.js"><link rel="prefetch" href="/assets/js/81.5a9ab73c.js"><link rel="prefetch" href="/assets/js/82.82f8101f.js"><link rel="prefetch" href="/assets/js/83.16c731ea.js"><link rel="prefetch" href="/assets/js/84.ebb4499e.js"><link rel="prefetch" href="/assets/js/85.323932c6.js"><link rel="prefetch" href="/assets/js/86.5fe42af0.js"><link rel="prefetch" href="/assets/js/87.1e607b95.js"><link rel="prefetch" href="/assets/js/88.1cb1bb53.js"><link rel="prefetch" href="/assets/js/89.30b0fda7.js"><link rel="prefetch" href="/assets/js/9.c748d72e.js"><link rel="prefetch" href="/assets/js/90.050be28f.js"><link rel="prefetch" href="/assets/js/91.57dee3b4.js"><link rel="prefetch" href="/assets/js/92.5ec93ebb.js"><link rel="prefetch" href="/assets/js/93.5a3e28cc.js"><link rel="prefetch" href="/assets/js/94.ab209645.js"><link rel="prefetch" href="/assets/js/95.2a4ea0e2.js"><link rel="prefetch" href="/assets/js/96.41db9364.js"><link rel="prefetch" href="/assets/js/97.b936622c.js"><link rel="prefetch" href="/assets/js/98.32537222.js"><link rel="prefetch" href="/assets/js/99.64a3e64d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.130772cc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Pro Git</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">引言</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-1/" class="sidebar-heading clickable"><span>1. 起步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-2/" class="sidebar-heading clickable"><span>2. Git 基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-3/" class="sidebar-heading clickable"><span>3. Git 分支</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-4/" class="sidebar-heading clickable"><span>4. 服务器上的 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-5/" class="sidebar-heading clickable"><span>5. 分布式 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-6/" class="sidebar-heading clickable"><span>6. GitHub</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-7/" class="sidebar-heading clickable router-link-active open"><span>7. Git 工具</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter-7/1.html" class="sidebar-link">选择修订版本</a></li><li><a href="/chapter-7/2.html" class="sidebar-link">交互式暂存</a></li><li><a href="/chapter-7/3.html" class="sidebar-link">贮藏与清理</a></li><li><a href="/chapter-7/4.html" class="sidebar-link">签署工作</a></li><li><a href="/chapter-7/5.html" class="sidebar-link">搜索</a></li><li><a href="/chapter-7/6.html" class="active sidebar-link">重写历史</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter-7/6.html#修改最后一次提交" class="sidebar-link">修改最后一次提交</a></li><li class="sidebar-sub-header"><a href="/chapter-7/6.html#修改多个提交信息" class="sidebar-link">修改多个提交信息</a></li><li class="sidebar-sub-header"><a href="/chapter-7/6.html#重新排序提交" class="sidebar-link">重新排序提交</a></li><li class="sidebar-sub-header"><a href="/chapter-7/6.html#压缩提交" class="sidebar-link">压缩提交</a></li><li class="sidebar-sub-header"><a href="/chapter-7/6.html#拆分提交" class="sidebar-link">拆分提交</a></li><li class="sidebar-sub-header"><a href="/chapter-7/6.html#核武器级选项：filter-branch" class="sidebar-link">核武器级选项：filter-branch</a></li></ul></li><li><a href="/chapter-7/7.html" class="sidebar-link">重置揭密</a></li><li><a href="/chapter-7/8.html" class="sidebar-link">高级合并</a></li><li><a href="/chapter-7/9.html" class="sidebar-link">Rerere</a></li><li><a href="/chapter-7/10.html" class="sidebar-link">使用 Git 调试</a></li><li><a href="/chapter-7/11.html" class="sidebar-link">子模块</a></li><li><a href="/chapter-7/12.html" class="sidebar-link">打包</a></li><li><a href="/chapter-7/13.html" class="sidebar-link">替换</a></li><li><a href="/chapter-7/14.html" class="sidebar-link">凭证存储</a></li><li><a href="/chapter-7/15.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-8/" class="sidebar-heading clickable"><span>8. 自定义 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-9/" class="sidebar-heading clickable"><span>9. Git 与其他系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-10/" class="sidebar-heading clickable"><span>10. Git 内部原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-A/" class="sidebar-heading clickable"><span>附录 A. 在其它环境中使用 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-B/" class="sidebar-heading clickable"><span>附录 B. 在你的应用中嵌入 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-C/" class="sidebar-heading clickable"><span>附录 C. Git 命令</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="重写历史"><a href="#重写历史" class="header-anchor">#</a> 重写历史</h1> <p>许多时候，在使用 Git 时，你可能想要修订提交历史。
Git 很棒的一点是它允许你在最后时刻做决定。
你可以在将暂存区内容提交前决定哪些文件进入提交，可以通过 <code class="literal">git stash</code> 来决定不与某些内容工作，
也可以重写已经发生的提交就像它们以另一种方式发生的一样。
这可能涉及改变提交的顺序，改变提交中的信息或修改文件，将提交压缩或是拆分，
或完全地移除提交——在将你的工作成果与他人共享之前。</p> <p>在本节中，你可以学到如何完成这些工作，这样在与他人分享你的工作成果时你的提交历史将如你所愿地展示出来。</p> <aside title="Note: 在满意之前不要推送你的工作" epub:type="note" class="admonition note custom-block tip"><p class="custom-block-title">提示</p> <h2>在满意之前不要推送你的工作</h2> <div class="content"><p>Git 的基本原则之一是，由于克隆中有很多工作是本地的，因此你可以 <strong>在本地</strong> 随便重写历史记录。
然而一旦推送了你的工作，那就完全是另一回事了，除非你有充分的理由进行更改，否则应该将推送的工作视为最终结果。
简而言之，在对它感到满意并准备与他人分享之前，应当避免推送你的工作。</p></div></aside> <h2 id="修改最后一次提交"><a href="#修改最后一次提交" class="header-anchor">#</a> 修改最后一次提交</h2> <p>修改你最近一次提交可能是所有修改历史提交的操作中最常见的一个。
对于你的最近一次提交，你往往想做两件事情：简单地修改提交信息，
或者通过添加、移除或修改文件来更改提交实际的内容。</p> <p>如果，你只是想修改最近一次提交的提交信息，那么很简单：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git commit --amend</code></pre> <p>上面这条命令会将最后一次的提交信息载入到编辑器中供你修改。
当保存并关闭编辑器后，编辑器会将更新后的提交信息写入新提交中，它会成为新的最后一次提交。</p> <p>另一方面，如果你想要修改最后一次提交的实际内容，那么流程很相似：首先作出你想要补上的修改，
暂存它们，然后用 <code class="literal">git commit --amend</code> 以新的改进后的提交来 <strong>替换</strong> 掉旧有的最后一次提交，</p> <p>使用这个技巧的时候需要小心，因为修正会改变提交的 SHA-1 校验和。
它类似于一个小的变基——如果已经推送了最后一次提交就不要修正它。</p> <aside title="Tip: 修补后的提交可能需要修补提交信息" epub:type="help" class="admonition tip custom-block"><p class="custom-block-title">提示</p> <h2>修补后的提交可能需要修补提交信息</h2> <div class="content"><p>当你在修补一次提交时，可以同时修改提交信息和提交内容。
如果你修补了提交的内容，那么几乎肯定要更新提交消息以反映修改后的内容。</p> <p>另一方面，如果你的修补是琐碎的（如修改了一个笔误或添加了一个忘记暂存的文件），
那么之前的提交信息不必修改，你只需作出更改，暂存它们，然后通过以下命令避免不必要的编辑器环节即可：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git commit --amend --no-edit</code></pre></div></aside> <h2 id="修改多个提交信息"><a href="#修改多个提交信息" class="header-anchor">#</a> 修改多个提交信息</h2> <p>为了修改在提交历史中较远的提交，必须使用更复杂的工具。
Git 没有一个改变历史工具，但是可以使用变基工具来变基一系列提交，基于它们原来的 HEAD 而不是将其移动到另一个新的上面。
通过交互式变基工具，可以在任何想要修改的提交后停止，然后修改信息、添加文件或做任何想做的事情。
可以通过给 <code class="literal">git rebase</code> 增加 <code class="literal">-i</code> 选项来交互式地运行变基。
必须指定想要重写多久远的历史，这可以通过告诉命令将要变基到的提交来做到。</p> <p>例如，如果想要修改最近三次提交信息，或者那组提交中的任意一个提交信息，
将想要修改的最近一次提交的父提交作为参数传递给 <code class="literal">git rebase -i</code> 命令，即  <code class="literal">HEAD~2^</code> 或 <code class="literal">HEAD~3</code>。
记住 <code class="literal">~3</code> 可能比较容易，因为你正尝试修改最后三次提交；但是注意实际上指定了以前的四次提交，即想要修改提交的父提交：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git rebase -i HEAD~3</code></pre> <p>再次记住这是一个变基命令——在 <code class="literal">HEAD~3..HEAD</code> 范围内的每一个修改了提交信息的提交及其 <strong>所有后裔</strong> 都会被重写。
不要涉及任何已经推送到中央服务器的提交——这样做会产生一次变更的两个版本，因而使他人困惑。</p> <p>运行这个命令会在文本编辑器上给你一个提交的列表，看起来像下面这样：</p> <pre class="language-bash"><code>pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file

<span style="font-weight:bold;">#</span> Rebase 710f0f8..a5f4a0d onto 710f0f8
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> Commands:
<span style="font-weight:bold;">#</span> p, pick &lt;commit&gt; = use commit
<span style="font-weight:bold;">#</span> r, reword &lt;commit&gt; = use commit, but edit the commit message
<span style="font-weight:bold;">#</span> e, edit &lt;commit&gt; = use commit, but stop <span style="font-weight:bold;">for</span> amending
<span style="font-weight:bold;">#</span> s, squash &lt;commit&gt; = use commit, but meld into previous commit
<span style="font-weight:bold;">#</span> f, fixup &lt;commit&gt; = like <span style="font-style:italic;">&quot;squash&quot;</span>, but discard this commit<span style="font-style:italic;">'s log message</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> x, exec &lt;command&gt; = run command (the rest of the line) using shell</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> b, break = stop here (continue rebase later with '</span>git rebase --continue<span style="font-style:italic;">')</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> d, drop &lt;commit&gt; = remove commit</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> l, label &lt;label&gt; = label current HEAD with a name</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> t, reset &lt;label&gt; = reset HEAD to a label</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> .       create a merge commit using the original merge commit'</span>s
<span style="font-weight:bold;">#</span> .       message (or the oneline, <span style="font-weight:bold;">if</span> no original merge commit was
<span style="font-weight:bold;">#</span> .       specified). Use -c &lt;commit&gt; to reword the commit message.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> These lines can be re-ordered; they are executed from top to bottom.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> If you remove a line here THAT COMMIT WILL BE LOST.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> However, <span style="font-weight:bold;">if</span> you remove everything, the rebase will be aborted.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> Note that empty commits are commented out</code></pre> <p>需要重点注意的是相对于正常使用的 <code class="literal">log</code> 命令，这些提交显示的顺序是相反的。
运行一次 <em>log</em> 命令，会看到类似这样的东西：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git log --pretty=format:<span style="font-style:italic;">&quot;%h %s&quot;</span> HEAD~3..HEAD
a5f4a0d added cat-file
310154e updated README formatting and added blame
f7f3f6d changed my name a bit</code></pre> <p>注意其中的反序显示。
交互式变基给你一个它将会运行的脚本。
它将会从你在命令行中指定的提交（<code class="literal">HEAD~3</code>）开始，从上到下的依次重演每一个提交引入的修改。
它将最旧的而不是最新的列在上面，因为那会是第一个将要重演的。</p> <p>你需要修改脚本来让它停留在你想修改的变更上。
要达到这个目的，你只要将你想修改的每一次提交前面的 ‘pick’ 改为 ‘edit’。
例如，只想修改第三次提交信息，可以像下面这样修改文件：</p> <pre class="language-bash"><code>edit f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre> <p>当保存并退出编辑器时，Git 将你带回到列表中的最后一次提交，把你送回命令行并提示以下信息：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git rebase -i HEAD~3
Stopped at f7f3f6d... changed my name a bit
You can amend the commit now, with

       git commit --amend

Once you're satisfied with your changes, run

       git rebase --continue</code></pre> <p>这些指令准确地告诉你该做什么。
输入</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git commit --amend</code></pre> <p>修改提交信息，然后退出编辑器。
然后，运行</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git rebase --continue</code></pre> <p>这个命令将会自动地应用另外两个提交，然后就完成了。
如果需要将不止一处的 pick 改为 edit，需要在每一个修改为 edit 的提交上重复这些步骤。
每一次，Git 将会停止，让你修正提交，然后继续直到完成。</p> <h2 id="重新排序提交"><a href="#重新排序提交" class="header-anchor">#</a> 重新排序提交</h2> <p>也可以使用交互式变基来重新排序或完全移除提交。
如果想要移除 “added cat-file” 提交然后修改另外两个提交引入的顺序，可以将变基脚本从这样：</p> <pre class="language-bash"><code>pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre> <p>改为这样：</p> <pre class="language-bash"><code>pick 310154e updated README formatting and added blame
pick f7f3f6d changed my name a bit</code></pre> <p>当保存并退出编辑器时，Git 将你的分支带回这些提交的父提交，应用 <code class="literal">310154e</code> 然后应用 <code class="literal">f7f3f6d</code>，最后停止。
事实修改了那些提交的顺序并完全地移除了 “added cat-file” 提交。</p> <h2 id="压缩提交"><a href="#压缩提交" class="header-anchor">#</a> 压缩提交</h2> <p>通过交互式变基工具，也可以将一连串提交压缩成一个单独的提交。
在变基信息中脚本给出了有用的指令：</p> <pre class="language-bash"><code><span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> Commands:
<span style="font-weight:bold;">#</span> p, pick &lt;commit&gt; = use commit
<span style="font-weight:bold;">#</span> r, reword &lt;commit&gt; = use commit, but edit the commit message
<span style="font-weight:bold;">#</span> e, edit &lt;commit&gt; = use commit, but stop <span style="font-weight:bold;">for</span> amending
<span style="font-weight:bold;">#</span> s, squash &lt;commit&gt; = use commit, but meld into previous commit
<span style="font-weight:bold;">#</span> f, fixup &lt;commit&gt; = like <span style="font-style:italic;">&quot;squash&quot;</span>, but discard this commit<span style="font-style:italic;">'s log message</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> x, exec &lt;command&gt; = run command (the rest of the line) using shell</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> b, break = stop here (continue rebase later with '</span>git rebase --continue<span style="font-style:italic;">')</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> d, drop &lt;commit&gt; = remove commit</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> l, label &lt;label&gt; = label current HEAD with a name</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> t, reset &lt;label&gt; = reset HEAD to a label</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span>
<span style="font-weight:bold;">#</span><span style="font-style:italic;"> .       create a merge commit using the original merge commit'</span>s
<span style="font-weight:bold;">#</span> .       message (or the oneline, <span style="font-weight:bold;">if</span> no original merge commit was
<span style="font-weight:bold;">#</span> .       specified). Use -c &lt;commit&gt; to reword the commit message.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> These lines can be re-ordered; they are executed from top to bottom.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> If you remove a line here THAT COMMIT WILL BE LOST.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> However, <span style="font-weight:bold;">if</span> you remove everything, the rebase will be aborted.
<span style="font-weight:bold;">#</span>
<span style="font-weight:bold;">#</span> Note that empty commits are commented out</code></pre> <p>如果，指定 “squash” 而不是 “pick” 或 “edit”，Git 将应用两者的修改并合并提交信息在一起。
所以，如果想要这三次提交变为一个提交，可以这样修改脚本：</p> <pre class="language-bash"><code>pick f7f3f6d changed my name a bit
squash 310154e updated README formatting and added blame
squash a5f4a0d added cat-file</code></pre> <p>当保存并退出编辑器时，Git 应用所有的三次修改然后将你放到编辑器中来合并三次提交信息：</p> <pre class="language-bash"><code><span style="font-weight:bold;">#</span> This is a combination of 3 commits.
<span style="font-weight:bold;">#</span> The first commit<span style="border:1px solid #FF0000;">'</span>s message is:
changed my name a bit

<span style="font-weight:bold;">#</span> This is the 2nd commit message:

updated README formatting and added blame

<span style="font-weight:bold;">#</span> This is the 3rd commit message:

added cat-file</code></pre> <p>当你保存之后，你就拥有了一个包含前三次提交的全部变更的提交。</p> <h2 id="拆分提交"><a href="#拆分提交" class="header-anchor">#</a> 拆分提交</h2> <p>拆分一个提交会撤消这个提交，然后多次地部分地暂存与提交直到完成你所需次数的提交。
例如，假设想要拆分三次提交的中间那次提交。
想要将它拆分为两次提交：第一个 “updated README formatting”，第二个 “added blame” 来代替原来的 “updated README formatting and added blame”。
可以通过修改 <code class="literal">rebase -i</code> 的脚本来做到这点，将要拆分的提交的指令修改为 “edit”：</p> <pre class="language-bash"><code>pick f7f3f6d changed my name a bit
edit 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre> <p>然后，当脚本将你进入到命令行时，重置那个提交，拿到被重置的修改，从中创建几次提交。
当保存并退出编辑器时，Git 带你到列表中第一个提交的父提交，应用第一个提交（<code class="literal">f7f3f6d</code>），
应用第二个提交（<code class="literal">310154e</code>），然后让你进入命令行。
那里，可以通过 <code class="literal">git reset HEAD^</code> 做一次针对那个提交的混合重置，实际上将会撤消那次提交并将修改的文件未暂存。
现在可以暂存并提交文件直到有几个提交，然后当完成时运行 <code class="literal">git rebase --continue</code>：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git reset HEAD^
<span style="font-weight:bold;">$</span> git add README
<span style="font-weight:bold;">$</span> git commit -m <span style="font-style:italic;">'updated README formatting'</span>
<span style="font-weight:bold;">$</span> git add lib/simplegit.rb
<span style="font-weight:bold;">$</span> git commit -m <span style="font-style:italic;">'added blame'</span>
<span style="font-weight:bold;">$</span> git rebase --continue</code></pre> <p>Git 在脚本中应用最后一次提交（<code class="literal">a5f4a0d</code>），历史记录看起来像这样：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git log -4 --pretty=format:<span style="font-style:italic;">&quot;%h %s&quot;</span>
1c002dd added cat-file
9b29157 added blame
35cfb2b updated README formatting
f3cc40e changed my name a bit</code></pre> <p>再次强调，这些改动了所有在列表中的提交的 SHA-1 校验和，所以要确保列表中的提交还没有推送到共享仓库中。</p> <h2 id="核武器级选项：filter-branch"><a href="#核武器级选项：filter-branch" class="header-anchor">#</a> 核武器级选项：filter-branch</h2> <p>有另一个历史改写的选项，如果想要通过脚本的方式改写大量提交的话可以使用它——例如，全局修改你的邮箱地址或从每一个提交中移除一个文件。
这个命令是 <code class="literal">filter-branch</code>，它可以改写历史中大量的提交，除非你的项目还没有公开并且其他人没有基于要改写的工作的提交做的工作，否则你不应当使用它。
然而，它可以很有用。
你将会学习到几个常用的用途，这样就得到了它适合使用地方的想法。</p> <aside title="Caution" epub:type="warning" class="admonition caution custom-block warning"><p class="custom-block-title">小心</p> <div class="content"><p><code class="literal">git filter-branch</code> 有很多陷阱，不再推荐使用它来重写历史。
请考虑使用 <code class="literal">git-filter-repo</code>，它是一个 Python 脚本，相比大多数使用 <code class="literal">filter-branch</code>
的应用来说，它做得要更好。它的文档和源码可访问 <a href="https://github.com/newren/git-filter-repo" class="link">https://github.com/newren/git-filter-repo</a> 获取。</p></div></aside> <h3 id="从每一个提交中移除一个文件"><a href="#从每一个提交中移除一个文件" class="header-anchor">#</a> 从每一个提交中移除一个文件</h3> <p>这经常发生。
有人粗心地通过 <code class="literal">git add .</code> 提交了一个巨大的二进制文件，你想要从所有地方删除。
可能偶然地提交了一个包括一个密码的文件，然而你想要开源项目。
<code class="literal">filter-branch</code> 是一个可能会用来擦洗整个提交历史的工具。
为了从整个提交历史中移除一个叫做 <code class="literal">passwords.txt</code> 的文件，可以使用 <code class="literal">--tree-filter</code> 选项给 <code class="literal">filter-branch</code>：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git filter-branch --tree-filter <span style="font-style:italic;">'rm -f passwords.txt'</span> HEAD
Rewrite 6b9b3cf04e7c5686a9cb838c3f36a8cb6a0fc2bd (21/21)
Ref 'refs/heads/master' was rewritten</code></pre> <p><code class="literal">--tree-filter</code> 选项在检出项目的每一个提交后运行指定的命令然后重新提交结果。
在本例中，你从每一个快照中移除了一个叫作 <code class="literal">passwords.txt</code> 的文件，无论它是否存在。
如果想要移除所有偶然提交的编辑器备份文件，可以运行类似 <code class="literal">git filter-branch --tree-filter 'rm -f *~' HEAD</code> 的命令。</p> <p>最后将可以看到 Git 重写树与提交然后移动分支指针。
通常一个好的想法是在一个测试分支中做这件事，然后当你决定最终结果是真正想要的，可以硬重置 <code class="literal">master</code> 分支。
为了让 <code class="literal">filter-branch</code> 在所有分支上运行，可以给命令传递 <code class="literal">--all</code> 选项。</p> <h3 id="使一个子目录做为新的根目录"><a href="#使一个子目录做为新的根目录" class="header-anchor">#</a> 使一个子目录做为新的根目录</h3> <p>假设已经从另一个源代码控制系统中导入，并且有几个没意义的子目录（<code class="literal">trunk</code>、<code class="literal">tags</code> 等等）。
如果想要让 <code class="literal">trunk</code> 子目录作为每一个提交的新的项目根目录，<code class="literal">filter-branch</code> 也可以帮助你那么做：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git filter-branch --subdirectory-filter trunk HEAD
Rewrite 856f0bf61e41a27326cdae8f09fe708d679f596f (12/12)
Ref 'refs/heads/master' was rewritten</code></pre> <p>现在新项目根目录是 <code class="literal">trunk</code> 子目录了。
Git 会自动移除所有不影响子目录的提交。</p> <h3 id="全局修改邮箱地址"><a href="#全局修改邮箱地址" class="header-anchor">#</a> 全局修改邮箱地址</h3> <p>另一个常见的情形是在你开始工作时忘记运行 <code class="literal">git config</code> 来设置你的名字与邮箱地址，
或者你想要开源一个项目并且修改所有你的工作邮箱地址为你的个人邮箱地址。
任何情形下，你也可以通过 <code class="literal">filter-branch</code> 来一次性修改多个提交中的邮箱地址。
需要小心的是只修改你自己的邮箱地址，所以你使用 <code class="literal">--commit-filter</code>：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git filter-branch --commit-filter <span style="border:1px solid #FF0000;">'</span>
        if [ &quot;$GIT_AUTHOR_EMAIL&quot; = &quot;schacon@localhost&quot; ];
        then
                GIT_AUTHOR_NAME=&quot;Scott Chacon&quot;;
                GIT_AUTHOR_EMAIL=&quot;schacon@example.com&quot;;
                git commit-tree &quot;$@&quot;;
        else
                git commit-tree &quot;$@&quot;;
        fi' HEAD</code></pre> <p>这会遍历并重写每一个提交来包含你的新邮箱地址。
因为提交包含了它们父提交的 SHA-1 校验和，这个命令会修改你的历史中的每一个提交的 SHA-1 校验和，
而不仅仅只是那些匹配邮箱地址的提交。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/chapter-7/5.html" class="prev">
        搜索
      </a></span> <span class="next"><a href="/chapter-7/7.html">
        重置揭密
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e343c26e.js" defer></script><script src="/assets/js/2.c0327591.js" defer></script><script src="/assets/js/111.a049971f.js" defer></script>
  </body>
</html>
