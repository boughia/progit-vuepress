<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>配置服务器 | Pro Git</title>
    <meta name="description" content="Pro Git 第二版中文版">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.130772cc.css" as="style"><link rel="preload" href="/assets/js/app.e343c26e.js" as="script"><link rel="preload" href="/assets/js/2.c0327591.js" as="script"><link rel="preload" href="/assets/js/93.5a3e28cc.js" as="script"><link rel="prefetch" href="/assets/js/10.0f9cab2e.js"><link rel="prefetch" href="/assets/js/100.83085317.js"><link rel="prefetch" href="/assets/js/101.56c6cce3.js"><link rel="prefetch" href="/assets/js/102.415183d7.js"><link rel="prefetch" href="/assets/js/103.65e1f37c.js"><link rel="prefetch" href="/assets/js/104.4844f2f3.js"><link rel="prefetch" href="/assets/js/105.66c87d19.js"><link rel="prefetch" href="/assets/js/106.05b2e48e.js"><link rel="prefetch" href="/assets/js/107.929c5d0f.js"><link rel="prefetch" href="/assets/js/108.7b376e69.js"><link rel="prefetch" href="/assets/js/109.1a730133.js"><link rel="prefetch" href="/assets/js/11.a6d7b909.js"><link rel="prefetch" href="/assets/js/110.191355ad.js"><link rel="prefetch" href="/assets/js/111.a049971f.js"><link rel="prefetch" href="/assets/js/112.482ffc61.js"><link rel="prefetch" href="/assets/js/113.d94b639c.js"><link rel="prefetch" href="/assets/js/114.8b9356fb.js"><link rel="prefetch" href="/assets/js/115.ebf1e18a.js"><link rel="prefetch" href="/assets/js/116.18b899b1.js"><link rel="prefetch" href="/assets/js/117.42a1b8c4.js"><link rel="prefetch" href="/assets/js/118.3a9d2ee3.js"><link rel="prefetch" href="/assets/js/119.4020833f.js"><link rel="prefetch" href="/assets/js/12.5d2796d3.js"><link rel="prefetch" href="/assets/js/120.9fae7990.js"><link rel="prefetch" href="/assets/js/121.cb3ef973.js"><link rel="prefetch" href="/assets/js/13.f69c9e48.js"><link rel="prefetch" href="/assets/js/14.6debe4be.js"><link rel="prefetch" href="/assets/js/15.a7c94022.js"><link rel="prefetch" href="/assets/js/16.6609021c.js"><link rel="prefetch" href="/assets/js/17.34ba32b5.js"><link rel="prefetch" href="/assets/js/18.4dd74348.js"><link rel="prefetch" href="/assets/js/19.2f410429.js"><link rel="prefetch" href="/assets/js/20.16ec0bd3.js"><link rel="prefetch" href="/assets/js/21.ad1ca29b.js"><link rel="prefetch" href="/assets/js/22.293aa5c6.js"><link rel="prefetch" href="/assets/js/23.025d3c7a.js"><link rel="prefetch" href="/assets/js/24.770fb3e1.js"><link rel="prefetch" href="/assets/js/25.6ce5a0ac.js"><link rel="prefetch" href="/assets/js/26.6404265b.js"><link rel="prefetch" href="/assets/js/27.62decef4.js"><link rel="prefetch" href="/assets/js/28.d1136794.js"><link rel="prefetch" href="/assets/js/29.95a71153.js"><link rel="prefetch" href="/assets/js/3.c6496835.js"><link rel="prefetch" href="/assets/js/30.eae133de.js"><link rel="prefetch" href="/assets/js/31.a6e572c3.js"><link rel="prefetch" href="/assets/js/32.4fc54ce1.js"><link rel="prefetch" href="/assets/js/33.d1c0ecba.js"><link rel="prefetch" href="/assets/js/34.29586ee8.js"><link rel="prefetch" href="/assets/js/35.8e480916.js"><link rel="prefetch" href="/assets/js/36.5b537183.js"><link rel="prefetch" href="/assets/js/37.40c06fd9.js"><link rel="prefetch" href="/assets/js/38.555815d4.js"><link rel="prefetch" href="/assets/js/39.6d5293e5.js"><link rel="prefetch" href="/assets/js/4.e8424aa9.js"><link rel="prefetch" href="/assets/js/40.78797741.js"><link rel="prefetch" href="/assets/js/41.ac76af08.js"><link rel="prefetch" href="/assets/js/42.e7d51b5d.js"><link rel="prefetch" href="/assets/js/43.b20d0fd6.js"><link rel="prefetch" href="/assets/js/44.e29a7c46.js"><link rel="prefetch" href="/assets/js/45.cdea70ee.js"><link rel="prefetch" href="/assets/js/46.9c95c270.js"><link rel="prefetch" href="/assets/js/47.ba588e60.js"><link rel="prefetch" href="/assets/js/48.a8b188ed.js"><link rel="prefetch" href="/assets/js/49.5c609647.js"><link rel="prefetch" href="/assets/js/5.b1d6f09c.js"><link rel="prefetch" href="/assets/js/50.662cc18e.js"><link rel="prefetch" href="/assets/js/51.5ff994dd.js"><link rel="prefetch" href="/assets/js/52.b1b6dd6c.js"><link rel="prefetch" href="/assets/js/53.bd783506.js"><link rel="prefetch" href="/assets/js/54.a05ff5b6.js"><link rel="prefetch" href="/assets/js/55.c30a6cad.js"><link rel="prefetch" href="/assets/js/56.44021f37.js"><link rel="prefetch" href="/assets/js/57.90e56f36.js"><link rel="prefetch" href="/assets/js/58.9ec15505.js"><link rel="prefetch" href="/assets/js/59.8f4ffc72.js"><link rel="prefetch" href="/assets/js/6.49fca771.js"><link rel="prefetch" href="/assets/js/60.8064b38b.js"><link rel="prefetch" href="/assets/js/61.d570ac20.js"><link rel="prefetch" href="/assets/js/62.c66ac933.js"><link rel="prefetch" href="/assets/js/63.d01f285e.js"><link rel="prefetch" href="/assets/js/64.a04e3c07.js"><link rel="prefetch" href="/assets/js/65.af0f13b3.js"><link rel="prefetch" href="/assets/js/66.f81074cc.js"><link rel="prefetch" href="/assets/js/67.47db8798.js"><link rel="prefetch" href="/assets/js/68.50332586.js"><link rel="prefetch" href="/assets/js/69.059056ac.js"><link rel="prefetch" href="/assets/js/7.225eae41.js"><link rel="prefetch" href="/assets/js/70.c46fd0e9.js"><link rel="prefetch" href="/assets/js/71.d45f53f9.js"><link rel="prefetch" href="/assets/js/72.eef7975a.js"><link rel="prefetch" href="/assets/js/73.d947c914.js"><link rel="prefetch" href="/assets/js/74.cc528edb.js"><link rel="prefetch" href="/assets/js/75.7e89a25f.js"><link rel="prefetch" href="/assets/js/76.68b7cb39.js"><link rel="prefetch" href="/assets/js/77.f51671b0.js"><link rel="prefetch" href="/assets/js/78.d940a766.js"><link rel="prefetch" href="/assets/js/79.657d22ce.js"><link rel="prefetch" href="/assets/js/8.1c488769.js"><link rel="prefetch" href="/assets/js/80.b7eef56c.js"><link rel="prefetch" href="/assets/js/81.5a9ab73c.js"><link rel="prefetch" href="/assets/js/82.82f8101f.js"><link rel="prefetch" href="/assets/js/83.16c731ea.js"><link rel="prefetch" href="/assets/js/84.ebb4499e.js"><link rel="prefetch" href="/assets/js/85.323932c6.js"><link rel="prefetch" href="/assets/js/86.5fe42af0.js"><link rel="prefetch" href="/assets/js/87.1e607b95.js"><link rel="prefetch" href="/assets/js/88.1cb1bb53.js"><link rel="prefetch" href="/assets/js/89.30b0fda7.js"><link rel="prefetch" href="/assets/js/9.c748d72e.js"><link rel="prefetch" href="/assets/js/90.050be28f.js"><link rel="prefetch" href="/assets/js/91.57dee3b4.js"><link rel="prefetch" href="/assets/js/92.5ec93ebb.js"><link rel="prefetch" href="/assets/js/94.ab209645.js"><link rel="prefetch" href="/assets/js/95.2a4ea0e2.js"><link rel="prefetch" href="/assets/js/96.41db9364.js"><link rel="prefetch" href="/assets/js/97.b936622c.js"><link rel="prefetch" href="/assets/js/98.32537222.js"><link rel="prefetch" href="/assets/js/99.64a3e64d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.130772cc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Pro Git</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">引言</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-1/" class="sidebar-heading clickable"><span>1. 起步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-2/" class="sidebar-heading clickable"><span>2. Git 基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-3/" class="sidebar-heading clickable"><span>3. Git 分支</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-4/" class="sidebar-heading clickable router-link-active open"><span>4. 服务器上的 Git</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter-4/1.html" class="sidebar-link">协议</a></li><li><a href="/chapter-4/2.html" class="sidebar-link">在服务器上搭建 Git</a></li><li><a href="/chapter-4/3.html" class="sidebar-link">生成 SSH 公钥</a></li><li><a href="/chapter-4/4.html" class="active sidebar-link">配置服务器</a></li><li><a href="/chapter-4/5.html" class="sidebar-link">Git 守护进程</a></li><li><a href="/chapter-4/6.html" class="sidebar-link">Smart HTTP</a></li><li><a href="/chapter-4/7.html" class="sidebar-link">GitWeb</a></li><li><a href="/chapter-4/8.html" class="sidebar-link">GitLab</a></li><li><a href="/chapter-4/9.html" class="sidebar-link">第三方托管的选择</a></li><li><a href="/chapter-4/10.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-5/" class="sidebar-heading clickable"><span>5. 分布式 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-6/" class="sidebar-heading clickable"><span>6. GitHub</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-7/" class="sidebar-heading clickable"><span>7. Git 工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-8/" class="sidebar-heading clickable"><span>8. 自定义 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-9/" class="sidebar-heading clickable"><span>9. Git 与其他系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-10/" class="sidebar-heading clickable"><span>10. Git 内部原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-A/" class="sidebar-heading clickable"><span>附录 A. 在其它环境中使用 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-B/" class="sidebar-heading clickable"><span>附录 B. 在你的应用中嵌入 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-C/" class="sidebar-heading clickable"><span>附录 C. Git 命令</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="配置服务器"><a href="#配置服务器" class="header-anchor">#</a> 配置服务器</h1> <p>我们来看看如何配置服务器端的 SSH 访问。
本例中，我们将使用 <code class="literal">authorized_keys</code> 方法来对用户进行认证。
同时我们假设你使用的操作系统是标准的 Linux 发行版，比如 Ubuntu。
首先，创建一个操作系统用户 <code class="literal">git</code>，并为其建立一个 <code class="literal">.ssh</code> 目录。</p> <aside title="Note" epub:type="note" class="admonition note custom-block tip"><p class="custom-block-title">提示</p> <div class="content"><p>以下操作可通过 <code class="literal">ssh-copy-id</code> 命令自动完成，这样就不必手动复制并安装公钥了。</p></div></aside> <p>首先，创建一个操作系统用户 <code class="literal">git</code>，并为其建立一个 <code class="literal">.ssh</code> 目录。</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> sudo adduser git
<span style="font-weight:bold;">$</span> su git
<span style="font-weight:bold;">$</span> cd
<span style="font-weight:bold;">$</span> mkdir .ssh &amp;&amp; chmod 700 .ssh
<span style="font-weight:bold;">$</span> touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys</code></pre> <p>接着，我们需要为系统用户 <code class="literal">git</code> 的 <code class="literal">authorized_keys</code> 文件添加一些开发者 SSH 公钥。
假设我们已经获得了若干受信任的公钥，并将它们保存在临时文件中。
与前文类似，这些公钥看起来是这样的：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> cat /tmp/id_rsa.john.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4L
ojG6rs6hPB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4k
Yjh6541NYsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9Ez
Sdfd8AcCIicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myiv
O7TCUSBdLQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPq
dAv8JggJICUvax2T9va5 gsg-keypair</code></pre> <p>将这些公钥加入系统用户 <code class="literal">git</code> 的 <code class="literal">.ssh</code> 目录下 <code class="literal">authorized_keys</code> 文件的末尾：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> cat /tmp/id_rsa.john.pub &gt;&gt; ~/.ssh/authorized_keys
<span style="font-weight:bold;">$</span> cat /tmp/id_rsa.josie.pub &gt;&gt; ~/.ssh/authorized_keys
<span style="font-weight:bold;">$</span> cat /tmp/id_rsa.jessica.pub &gt;&gt; ~/.ssh/authorized_keys</code></pre> <p>现在我们来为开发者新建一个空仓库。可以借助带 <code class="literal">--bare</code> 选项的 <code class="literal">git init</code> 命令来做到这一点，该命令在初始化仓库时不会创建工作目录：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> cd /srv/git
<span style="font-weight:bold;">$</span> mkdir project.git
<span style="font-weight:bold;">$</span> cd project.git
<span style="font-weight:bold;">$</span> git init --bare
Initialized empty Git repository in /srv/git/project.git/</code></pre> <p>接着，John、Josie 或者 Jessica 中的任意一人可以将他们项目的最初版本推送到这个仓库中，
他只需将此仓库设置为项目的远程仓库并向其推送分支。
请注意，每添加一个新项目，都需要有人登录服务器取得 shell，并创建一个裸仓库。
我们假定这个设置了 <code class="literal">git</code> 用户和 Git 仓库的服务器使用 <code class="literal">gitserver</code> 作为主机名。
同时，假设该服务器运行在内网，并且你已在 DNS 配置中将 <code class="literal">gitserver</code> 指向此服务器。
那么我们可以运行如下命令（假定 <code class="literal">myproject</code> 是已有项目且其中已包含文件）：</p> <pre class="language-bash"><code><span style="font-weight:bold;">#</span> on John<span style="font-style:italic;">'s computer</span>
<span style="font-weight:bold;">$</span><span style="font-style:italic;"> cd myproject</span>
<span style="font-weight:bold;">$</span><span style="font-style:italic;"> git init</span>
<span style="font-weight:bold;">$</span><span style="font-style:italic;"> git add .</span>
<span style="font-weight:bold;">$</span><span style="font-style:italic;"> git commit -m '</span>initial commit<span style="border:1px solid #FF0000;">'</span>
<span style="font-weight:bold;">$</span> git remote add origin git@gitserver:/srv/git/project.git
<span style="font-weight:bold;">$</span> git push origin master</code></pre> <p>此时，其他开发者可以克隆此仓库，并推回各自的改动，步骤很简单：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git clone git@gitserver:/srv/git/project.git
<span style="font-weight:bold;">$</span> cd project
<span style="font-weight:bold;">$</span> vim README
<span style="font-weight:bold;">$</span> git commit -am <span style="font-style:italic;">'fix for the README file'</span>
<span style="font-weight:bold;">$</span> git push origin master</code></pre> <p>通过这种方法，你可以快速搭建一个具有读写权限、面向多个开发者的 Git 服务器。</p> <p>需要注意的是，目前所有（获得授权的）开发者用户都能以系统用户 <code class="literal">git</code> 的身份登录服务器从而获得一个普通 shell。
如果你想对此加以限制，则需要修改 <code class="literal">/etc/passwd</code> 文件中（<code class="literal">git</code> 用户所对应）的 shell 值。</p> <p>借助一个名为 <code class="literal">git-shell</code> 的受限 shell 工具，你可以方便地将用户 <code class="literal">git</code> 的活动限制在与 Git 相关的范围内。
该工具随 Git 软件包一同提供。如果将 <code class="literal">git-shell</code> 设置为用户 <code class="literal">git</code> 的登录 shell（login shell），
那么该用户便不能获得此服务器的普通 shell 访问权限。
若要使用 <code class="literal">git-shell</code>，需要用它替换掉 bash 或 csh，使其成为该用户的登录 shell。
为进行上述操作，首先你必须确保 <code class="literal">git-shell</code> 的完整路径名已存在于 <code class="literal">/etc/shells</code> 文件中：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> cat /etc/shells   <span style="font-style:italic;"># see if git-shell is already in there. If not...</span>
<span style="font-weight:bold;">$</span> which git-shell   <span style="font-style:italic;"># make sure git-shell is installed on your system.</span>
<span style="font-weight:bold;">$</span> sudo -e /etc/shells  <span style="font-style:italic;"># and add the path to git-shell from last command</span></code></pre> <p>现在你可以使用 <code class="literal">chsh &lt;username&gt; -s &lt;shell&gt;</code> 命令修改任一系统用户的 shell：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> sudo chsh git -s <span style="font-weight:bold;">$(</span>which git-shell<span style="font-weight:bold;">)</span></code></pre> <p>这样，用户 <code class="literal">git</code> 就只能利用 SSH 连接对 Git 仓库进行推送和拉取操作，而不能登录机器并取得普通 shell。
如果试图登录，你会发现尝试被拒绝，像这样：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> ssh git@gitserver
fatal: Interactive git shell is not enabled.
hint: ~/git-shell-commands should exist and have read and execute access.
Connection to gitserver closed.</code></pre> <p>此时，用户仍可通过 SSH 端口转发来访问任何可达的 git 服务器。
如果你想要避免它，可编辑 <code class="literal">authorized_keys</code> 文件并在所有想要限制的公钥之前添加以下选项：</p> <pre class="language-bash"><code>no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty</code></pre> <p>其结果如下：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> cat ~/.ssh/authorized_keys
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4LojG6rs6h
PB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4kYjh6541N
YsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9EzSdfd8AcC
IicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myivO7TCUSBd
LQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPqdAv8JggJ
ICUvax2T9va5 gsg-keypair

no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDEwENNMomTboYI+LJieaAY16qiXiH3wuvENhBG...</code></pre> <p>现在，网络相关的 Git 命令依然能够正常工作，但是开发者用户已经无法得到一个普通 shell 了。
正如输出信息所提示的，你也可以在 <code class="literal">git</code> 用户的主目录下建立一个目录，来对 <code class="literal">git-shell</code> 命令进行一定程度的自定义。
比如，你可以限制掉某些本应被服务器接受的 Git 命令，或者对刚才的 SSH 拒绝登录信息进行自定义，这样，当有开发者用户以类似方式尝试登录时，便会看到你的信息。
要了解更多有关自定义 shell 的信息，请运行 <code class="literal">git help shell</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/chapter-4/3.html" class="prev">
        生成 SSH 公钥
      </a></span> <span class="next"><a href="/chapter-4/5.html">
        Git 守护进程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e343c26e.js" defer></script><script src="/assets/js/2.c0327591.js" defer></script><script src="/assets/js/93.5a3e28cc.js" defer></script>
  </body>
</html>
