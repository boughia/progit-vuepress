<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>传输协议 | Pro Git</title>
    <meta name="description" content="Pro Git 第二版中文版">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.130772cc.css" as="style"><link rel="preload" href="/assets/js/app.e343c26e.js" as="script"><link rel="preload" href="/assets/js/2.c0327591.js" as="script"><link rel="preload" href="/assets/js/73.d947c914.js" as="script"><link rel="prefetch" href="/assets/js/10.0f9cab2e.js"><link rel="prefetch" href="/assets/js/100.83085317.js"><link rel="prefetch" href="/assets/js/101.56c6cce3.js"><link rel="prefetch" href="/assets/js/102.415183d7.js"><link rel="prefetch" href="/assets/js/103.65e1f37c.js"><link rel="prefetch" href="/assets/js/104.4844f2f3.js"><link rel="prefetch" href="/assets/js/105.66c87d19.js"><link rel="prefetch" href="/assets/js/106.05b2e48e.js"><link rel="prefetch" href="/assets/js/107.929c5d0f.js"><link rel="prefetch" href="/assets/js/108.7b376e69.js"><link rel="prefetch" href="/assets/js/109.1a730133.js"><link rel="prefetch" href="/assets/js/11.a6d7b909.js"><link rel="prefetch" href="/assets/js/110.191355ad.js"><link rel="prefetch" href="/assets/js/111.a049971f.js"><link rel="prefetch" href="/assets/js/112.482ffc61.js"><link rel="prefetch" href="/assets/js/113.d94b639c.js"><link rel="prefetch" href="/assets/js/114.8b9356fb.js"><link rel="prefetch" href="/assets/js/115.ebf1e18a.js"><link rel="prefetch" href="/assets/js/116.18b899b1.js"><link rel="prefetch" href="/assets/js/117.42a1b8c4.js"><link rel="prefetch" href="/assets/js/118.3a9d2ee3.js"><link rel="prefetch" href="/assets/js/119.4020833f.js"><link rel="prefetch" href="/assets/js/12.5d2796d3.js"><link rel="prefetch" href="/assets/js/120.9fae7990.js"><link rel="prefetch" href="/assets/js/121.cb3ef973.js"><link rel="prefetch" href="/assets/js/13.f69c9e48.js"><link rel="prefetch" href="/assets/js/14.6debe4be.js"><link rel="prefetch" href="/assets/js/15.a7c94022.js"><link rel="prefetch" href="/assets/js/16.6609021c.js"><link rel="prefetch" href="/assets/js/17.34ba32b5.js"><link rel="prefetch" href="/assets/js/18.4dd74348.js"><link rel="prefetch" href="/assets/js/19.2f410429.js"><link rel="prefetch" href="/assets/js/20.16ec0bd3.js"><link rel="prefetch" href="/assets/js/21.ad1ca29b.js"><link rel="prefetch" href="/assets/js/22.293aa5c6.js"><link rel="prefetch" href="/assets/js/23.025d3c7a.js"><link rel="prefetch" href="/assets/js/24.770fb3e1.js"><link rel="prefetch" href="/assets/js/25.6ce5a0ac.js"><link rel="prefetch" href="/assets/js/26.6404265b.js"><link rel="prefetch" href="/assets/js/27.62decef4.js"><link rel="prefetch" href="/assets/js/28.d1136794.js"><link rel="prefetch" href="/assets/js/29.95a71153.js"><link rel="prefetch" href="/assets/js/3.c6496835.js"><link rel="prefetch" href="/assets/js/30.eae133de.js"><link rel="prefetch" href="/assets/js/31.a6e572c3.js"><link rel="prefetch" href="/assets/js/32.4fc54ce1.js"><link rel="prefetch" href="/assets/js/33.d1c0ecba.js"><link rel="prefetch" href="/assets/js/34.29586ee8.js"><link rel="prefetch" href="/assets/js/35.8e480916.js"><link rel="prefetch" href="/assets/js/36.5b537183.js"><link rel="prefetch" href="/assets/js/37.40c06fd9.js"><link rel="prefetch" href="/assets/js/38.555815d4.js"><link rel="prefetch" href="/assets/js/39.6d5293e5.js"><link rel="prefetch" href="/assets/js/4.e8424aa9.js"><link rel="prefetch" href="/assets/js/40.78797741.js"><link rel="prefetch" href="/assets/js/41.ac76af08.js"><link rel="prefetch" href="/assets/js/42.e7d51b5d.js"><link rel="prefetch" href="/assets/js/43.b20d0fd6.js"><link rel="prefetch" href="/assets/js/44.e29a7c46.js"><link rel="prefetch" href="/assets/js/45.cdea70ee.js"><link rel="prefetch" href="/assets/js/46.9c95c270.js"><link rel="prefetch" href="/assets/js/47.ba588e60.js"><link rel="prefetch" href="/assets/js/48.a8b188ed.js"><link rel="prefetch" href="/assets/js/49.5c609647.js"><link rel="prefetch" href="/assets/js/5.b1d6f09c.js"><link rel="prefetch" href="/assets/js/50.662cc18e.js"><link rel="prefetch" href="/assets/js/51.5ff994dd.js"><link rel="prefetch" href="/assets/js/52.b1b6dd6c.js"><link rel="prefetch" href="/assets/js/53.bd783506.js"><link rel="prefetch" href="/assets/js/54.a05ff5b6.js"><link rel="prefetch" href="/assets/js/55.c30a6cad.js"><link rel="prefetch" href="/assets/js/56.44021f37.js"><link rel="prefetch" href="/assets/js/57.90e56f36.js"><link rel="prefetch" href="/assets/js/58.9ec15505.js"><link rel="prefetch" href="/assets/js/59.8f4ffc72.js"><link rel="prefetch" href="/assets/js/6.49fca771.js"><link rel="prefetch" href="/assets/js/60.8064b38b.js"><link rel="prefetch" href="/assets/js/61.d570ac20.js"><link rel="prefetch" href="/assets/js/62.c66ac933.js"><link rel="prefetch" href="/assets/js/63.d01f285e.js"><link rel="prefetch" href="/assets/js/64.a04e3c07.js"><link rel="prefetch" href="/assets/js/65.af0f13b3.js"><link rel="prefetch" href="/assets/js/66.f81074cc.js"><link rel="prefetch" href="/assets/js/67.47db8798.js"><link rel="prefetch" href="/assets/js/68.50332586.js"><link rel="prefetch" href="/assets/js/69.059056ac.js"><link rel="prefetch" href="/assets/js/7.225eae41.js"><link rel="prefetch" href="/assets/js/70.c46fd0e9.js"><link rel="prefetch" href="/assets/js/71.d45f53f9.js"><link rel="prefetch" href="/assets/js/72.eef7975a.js"><link rel="prefetch" href="/assets/js/74.cc528edb.js"><link rel="prefetch" href="/assets/js/75.7e89a25f.js"><link rel="prefetch" href="/assets/js/76.68b7cb39.js"><link rel="prefetch" href="/assets/js/77.f51671b0.js"><link rel="prefetch" href="/assets/js/78.d940a766.js"><link rel="prefetch" href="/assets/js/79.657d22ce.js"><link rel="prefetch" href="/assets/js/8.1c488769.js"><link rel="prefetch" href="/assets/js/80.b7eef56c.js"><link rel="prefetch" href="/assets/js/81.5a9ab73c.js"><link rel="prefetch" href="/assets/js/82.82f8101f.js"><link rel="prefetch" href="/assets/js/83.16c731ea.js"><link rel="prefetch" href="/assets/js/84.ebb4499e.js"><link rel="prefetch" href="/assets/js/85.323932c6.js"><link rel="prefetch" href="/assets/js/86.5fe42af0.js"><link rel="prefetch" href="/assets/js/87.1e607b95.js"><link rel="prefetch" href="/assets/js/88.1cb1bb53.js"><link rel="prefetch" href="/assets/js/89.30b0fda7.js"><link rel="prefetch" href="/assets/js/9.c748d72e.js"><link rel="prefetch" href="/assets/js/90.050be28f.js"><link rel="prefetch" href="/assets/js/91.57dee3b4.js"><link rel="prefetch" href="/assets/js/92.5ec93ebb.js"><link rel="prefetch" href="/assets/js/93.5a3e28cc.js"><link rel="prefetch" href="/assets/js/94.ab209645.js"><link rel="prefetch" href="/assets/js/95.2a4ea0e2.js"><link rel="prefetch" href="/assets/js/96.41db9364.js"><link rel="prefetch" href="/assets/js/97.b936622c.js"><link rel="prefetch" href="/assets/js/98.32537222.js"><link rel="prefetch" href="/assets/js/99.64a3e64d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.130772cc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Pro Git</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">引言</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-1/" class="sidebar-heading clickable"><span>1. 起步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-2/" class="sidebar-heading clickable"><span>2. Git 基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-3/" class="sidebar-heading clickable"><span>3. Git 分支</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-4/" class="sidebar-heading clickable"><span>4. 服务器上的 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-5/" class="sidebar-heading clickable"><span>5. 分布式 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-6/" class="sidebar-heading clickable"><span>6. GitHub</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-7/" class="sidebar-heading clickable"><span>7. Git 工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-8/" class="sidebar-heading clickable"><span>8. 自定义 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-9/" class="sidebar-heading clickable"><span>9. Git 与其他系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/chapter-10/" class="sidebar-heading clickable router-link-active open"><span>10. Git 内部原理</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter-10/1.html" class="sidebar-link">底层命令与上层命令</a></li><li><a href="/chapter-10/2.html" class="sidebar-link">Git 对象</a></li><li><a href="/chapter-10/3.html" class="sidebar-link">Git 引用</a></li><li><a href="/chapter-10/4.html" class="sidebar-link">包文件</a></li><li><a href="/chapter-10/5.html" class="sidebar-link">引用规范</a></li><li><a href="/chapter-10/6.html" class="active sidebar-link">传输协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter-10/6.html#哑协议" class="sidebar-link">哑协议</a></li><li class="sidebar-sub-header"><a href="/chapter-10/6.html#智能协议" class="sidebar-link">智能协议</a></li><li class="sidebar-sub-header"><a href="/chapter-10/6.html#协议总结" class="sidebar-link">协议总结</a></li></ul></li><li><a href="/chapter-10/7.html" class="sidebar-link">维护与数据恢复</a></li><li><a href="/chapter-10/8.html" class="sidebar-link">环境变量</a></li><li><a href="/chapter-10/9.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-A/" class="sidebar-heading clickable"><span>附录 A. 在其它环境中使用 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-B/" class="sidebar-heading clickable"><span>附录 B. 在你的应用中嵌入 Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/appendix-C/" class="sidebar-heading clickable"><span>附录 C. Git 命令</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="传输协议"><a href="#传输协议" class="header-anchor">#</a> 传输协议</h1> <p>Git 可以通过两种主要的方式在版本库之间传输数据：“哑（dumb）”协议和“智能（smart）”协议。
本节将会带你快速浏览这两种协议的运作方式。</p> <h2 id="哑协议"><a href="#哑协议" class="header-anchor">#</a> 哑协议</h2> <p>如果你正在架设一个基于 HTTP 协议的只读版本库，一般而言这种情况下使用的就是哑协议。
这个协议之所以被称为“哑”协议，是因为在传输过程中，服务端不需要有针对 Git 特有的代码；抓取过程是一系列 HTTP 的 <code class="literal">GET</code> 请求，这种情况下，客户端可以推断出服务端 Git 仓库的布局。</p> <aside title="Note" epub:type="note" class="admonition note custom-block tip"><p class="custom-block-title">提示</p> <div class="content"><p>现在已经很少使用哑协议了。
使用哑协议的版本库很难保证安全性和私有化，所以大多数 Git 服务器宿主（包括云端和本地）都会拒绝使用它。
一般情况下都建议使用智能协议，我们会在后面进行介绍。</p></div></aside> <p>让我们通过 simplegit 版本库来看看 <code class="literal">http-fetch</code> 的过程：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git clone http://server/simplegit-progit.git</code></pre> <p>它做的第一件事就是拉取 <code class="literal">info/refs</code> 文件。
这个文件是通过 <code class="literal">update-server-info</code> 命令生成的，这也解释了在使用 HTTP 传输时，必须把它设置为 <code class="literal">post-receive</code> 钩子的原因：</p> <pre class="source language-"><code>=&gt; GET info/refs
ca82a6dff817ec66f44342007202690a93763949     refs/heads/master</code></pre> <p>现在，你得到了一个远程引用和 SHA-1 值的列表。
接下来，你要确定 HEAD 引用是什么，这样你就知道在完成后应该被检出到工作目录的内容：</p> <pre class="source language-"><code>=&gt; GET HEAD
ref: refs/heads/master</code></pre> <p>这说明在完成抓取后，你需要检出 <code class="literal">master</code> 分支。
这时，你就可以开始遍历处理了。
因为你是从 <code class="literal">info/refs</code> 文件中所提到的 <code class="literal">ca82a6</code> 提交对象开始的，所以你的首要操作是获取它：</p> <pre class="source language-"><code>=&gt; GET objects/ca/82a6dff817ec66f44342007202690a93763949
(179 bytes of binary data)</code></pre> <p>你取回了一个对象——这是一个在服务端以松散格式保存的对象，是你通过使用静态 HTTP GET 请求获取的。
你可以使用 zlib 解压缩它，去除其头部，查看提交记录的内容：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> git cat-file -p ca82a6dff817ec66f44342007202690a93763949
tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf
parent 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
author Scott Chacon &lt;schacon@gmail.com&gt; 1205815931 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1240030591 -0700

changed the version number</code></pre> <p>接下来，你还要再获取两个对象，一个是树对象 <code class="literal">cfda3b</code>，它包含有我们刚刚获取的提交对象所指向的内容，另一个是它的父提交 <code class="literal">085bb3</code>：</p> <pre class="source language-"><code>=&gt; GET objects/08/5bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
(179 bytes of data)</code></pre> <p>这样就取得了你的下一个提交对象。
再抓取树对象：</p> <pre class="source language-"><code>=&gt; GET objects/cf/da3bf379e4f8dba8717dee55aab78aef7f4daf
(404 - Not Found)</code></pre> <p>噢——看起来这个树对象在服务端并不以松散格式对象存在，所以你得到了一个 404 响应，代表在 HTTP 服务端没有找到该对象。
这有好几个可能的原因——这个对象可能在替代版本库里面，或者在包文件里面。
Git 会首先检查所有列出的替代版本库：</p> <pre class="source language-"><code>=&gt; GET objects/info/http-alternates
(empty file)</code></pre> <p>如果这返回了一个包含替代版本库 URL 的列表，那么 Git 就会去那些地址检查松散格式对象和文件——这是一种能让派生项目共享对象以节省磁盘的好方法。
然而，在这个例子中，没有列出可用的替代版本库。所以你所需要的对象肯定在某个包文件中。
要检查服务端有哪些可用的包文件，你需要获取 <code class="literal">objects/info/packs</code> 文件，这里面有一个包文件列表（它也是通过执行 <code class="literal">update-server-info</code> 所生成的）：</p> <pre class="source language-"><code>=&gt; GET objects/info/packs
P pack-816a9b2334da9953e530f27bcac22082a9f5b835.pack</code></pre> <p>服务端只有一个包文件，所以你要的对象显然就在里面。但是你要先检查它的索引文件以确认。
即使服务端有多个包文件，这也是很有用的，因为这样你就可以知道你所需要的对象是在哪一个包文件里面：</p> <pre class="source language-"><code>=&gt; GET objects/pack/pack-816a9b2334da9953e530f27bcac22082a9f5b835.idx
(4k of binary data)</code></pre> <p>现在你有这个包文件的索引，你可以查看你要的对象是否在里面——
因为索引文件列出了这个包文件所包含的所有对象的 SHA-1 值，和该对象存在于包文件中的偏移量。
你的对象就在这里，接下来就是获取整个包文件：</p> <pre class="source language-"><code>=&gt; GET objects/pack/pack-816a9b2334da9953e530f27bcac22082a9f5b835.pack
(13k of binary data)</code></pre> <p>现在你也有了你的树对象，你可以继续在提交记录上漫游。
它们全部都在这个你刚下载的包文件里面，所以你不用继续向服务端请求更多下载了。
Git 会将开始时下载的 HEAD 引用所指向的 <code class="literal">master</code> 分支检出到工作目录。</p> <h2 id="智能协议"><a href="#智能协议" class="header-anchor">#</a> 智能协议</h2> <p>哑协议虽然很简单但效率略低，且它不能从客户端向服务端发送数据。
智能协议是更常用的传送数据的方法，但它需要在服务端运行一个进程，而这也是 Git 的智能之处——它可以读取本地数据，理解客户端有什么和需要什么，并为它生成合适的包文件。
总共有两组进程用于传输数据，它们分别负责上传和下载数据。</p> <h3 id="上传数据"><a href="#上传数据" class="header-anchor">#</a> 上传数据</h3> <p>
为了上传数据至远端，Git 使用 <code class="literal">send-pack</code> 和 <code class="literal">receive-pack</code> 进程。
运行在客户端上的 <code class="literal">send-pack</code> 进程连接到远端运行的 <code class="literal">receive-pack</code> 进程。</p> <h4 id="ssh"><a href="#ssh" class="header-anchor">#</a> SSH</h4> <p>举例来说，在项目中使用命令 <code class="literal">git push origin master</code> 时, <code class="literal">origin</code> 是由基于 SSH 协议的 URL 所定义的。
Git 会运行 <code class="literal">send-pack</code> 进程，它会通过 SSH 连接你的服务器。
它会尝试通过 SSH 在服务端执行命令，就像这样：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> ssh -x git@server <span style="font-style:italic;">&quot;git-receive-pack 'simplegit-progit.git'&quot;</span>
00a5ca82a6dff817ec66f4437202690a93763949 refs/heads/master report-status \
	delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1+github-607-gfba4028 delete-refs
0000</code></pre> <p><code class="literal">git-receive-pack</code> 命令会立即为它所拥有的每一个引用发送一行响应——在这个例子中，就只有 <code class="literal">master</code> 分支和它的 SHA-1 值。
第一行响应中也包含了一个服务端能力的列表（这里是 <code class="literal">report-status</code>、<code class="literal">delete-refs</code> 和一些其它的，包括客户端的识别码）。</p> <p>每一行以一个四位的十六进制值开始，用于指明本行的长度。
你看到第一行以 00a5 开始，这在十六进制中表示 165，意味着第一行有 165 字节。
下一行是 0000，表示服务端已完成了发送引用列表过程。</p> <p>现在它知道了服务端的状态，你的 <code class="literal">send-pack</code> 进程会判断哪些提交记录是它所拥有但服务端没有的。
<code class="literal">send-pack</code> 会告知 <code class="literal">receive-pack</code> 这次推送将会更新的各个引用。
举个例子，如果你正在更新 <code class="literal">master</code> 分支，并且增加 <code class="literal">experiment</code> 分支，这个 <code class="literal">send-pack</code> 的响应将会是像这样：</p> <pre class="source language-"><code>0076ca82a6dff817ec66f44342007202690a93763949 15027957951b64cf874c3557a0f3547bd83b3ff6 \
	refs/heads/master report-status
006c0000000000000000000000000000000000000000 cdfdb42577e2506715f8cfeacdbabc092bf63e8d \
	refs/heads/experiment
0000</code></pre> <p>第一行也包括了客户端的能力。
这里的全为 <em>0</em> 的 SHA-1 值表示之前没有过这个引用——因为你正要添加新的 experiment 引用。
删除引用时，将会看到相反的情况：右边的 SHA-1 值全为 <em>0</em>。</p> <p>连接是从下面这个请求开始的：</p> <pre class="source language-"><code>=&gt; GET http://server/simplegit-progit.git/info/refs?service=git-receive-pack
001f# service=git-receive-pack
00ab6c5f0e45abd7832bf23074a333f739977c9e8188 refs/heads/master report-status \
	delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1~vmg-bitmaps-bugaloo-608-g116744e
0000</code></pre> <p>这完成了客户端和服务端的第一次数据交换。
接下来客户端发起另一个请求，这次是一个 <code class="literal">POST</code> 请求，这个请求中包含了 <code class="literal">send-pack</code> 提供的数据。</p> <pre class="source language-"><code>=&gt; POST http://server/simplegit-progit.git/git-receive-pack</code></pre> <p>这个 <code class="literal">POST</code> 请求的内容是 <code class="literal">send-pack</code> 的输出和相应的包文件。
服务端在收到请求后相应地作出成功或失败的 HTTP 响应。</p> <h3 id="下载数据"><a href="#下载数据" class="header-anchor">#</a> 下载数据</h3> <p>
当你在下载数据时， <code class="literal">fetch-pack</code> 和 <code class="literal">upload-pack</code> 进程就起作用了。
客户端启动 <code class="literal">fetch-pack</code> 进程，连接至远端的 <code class="literal">upload-pack</code> 进程，以协商后续传输的数据。</p> <h4 id="ssh-2"><a href="#ssh-2" class="header-anchor">#</a> SSH</h4> <p>如果你通过 SSH 使用抓取功能，<code class="literal">fetch-pack</code> 会像这样运行：</p> <pre class="language-bash"><code><span style="font-weight:bold;">$</span> ssh -x git@server <span style="font-style:italic;">&quot;git-upload-pack 'simplegit-progit.git'&quot;</span></code></pre> <p>在 <code class="literal">fetch-pack</code> 连接后，<code class="literal">upload-pack</code> 会返回类似下面的内容：</p> <pre class="source language-"><code>00dfca82a6dff817ec66f44342007202690a93763949 HEAD multi_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fe2409a098dc3e53539a9028a94b6224db9d6a6b6 refs/heads/master
0000</code></pre> <p>这与 <code class="literal">receive-pack</code> 的响应很相似，但是这里所包含的能力是不同的。
而且它还包含 HEAD 引用所指向内容（<code class="literal">symref=HEAD:refs/heads/master</code>），这样如果客户端执行的是克隆，它就会知道要检出什么。</p> <p>这时候，<code class="literal">fetch-pack</code> 进程查看它自己所拥有的对象，并响应 “want” 和它需要的对象的 SHA-1 值。
它还会发送“have”和所有它已拥有的对象的 SHA-1 值。
在列表的最后，它还会发送“done”以通知 <code class="literal">upload-pack</code> 进程可以开始发送它所需对象的包文件：</p> <pre class="source language-"><code>003cwant ca82a6dff817ec66f44342007202690a93763949 ofs-delta
0032have 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
0009done
0000</code></pre> <h4 id="http-s"><a href="#http-s" class="header-anchor">#</a> HTTP(S)</h4> <p>抓取操作的握手需要两个 HTTP 请求。
第一个是向和哑协议中相同的端点发送 <code class="literal">GET</code> 请求：</p> <pre class="source language-"><code>=&gt; GET $GIT_URL/info/refs?service=git-upload-pack
001e# service=git-upload-pack
00e7ca82a6dff817ec66f44342007202690a93763949 HEAD multi_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed no-done symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fca82a6dff817ec66f44342007202690a93763949 refs/heads/master
0000</code></pre> <p>这和通过 SSH 使用 <code class="literal">git-upload-pack</code> 是非常相似的，但是第二个数据交换则是一个单独的请求：</p> <pre class="source language-"><code>=&gt; POST $GIT_URL/git-upload-pack HTTP/1.0
0032want 0a53e9ddeaddad63ad106860237bbf53411d11a7
0032have 441b40d833fdfa93eb2908e52742248faf0ee993
0000</code></pre> <p>这个输出格式还是和前面一样的。
这个请求的响应包含了所需要的包文件，并指明成功或失败。</p> <h2 id="协议总结"><a href="#协议总结" class="header-anchor">#</a> 协议总结</h2> <p>这一章节是传输协议的一个概貌。
传输协议还有很多其它的特性，像是 <code class="literal">multi_ack</code> 或 <code class="literal">side-band</code>，但是这些内容已经超出了本书的范围。
我们希望能给你展示客户端和服务端之间的基本交互过程；如果你需要更多的相关知识，你可以参阅 Git 的源代码。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/chapter-10/5.html" class="prev">
        引用规范
      </a></span> <span class="next"><a href="/chapter-10/7.html">
        维护与数据恢复
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e343c26e.js" defer></script><script src="/assets/js/2.c0327591.js" defer></script><script src="/assets/js/73.d947c914.js" defer></script>
  </body>
</html>
